/*! For license information please see bundle.js.LICENSE.txt */
(()=>{"use strict";var e={6489:(e,t)=>{t.parse=function(e,t){if("string"!=typeof e)throw new TypeError("argument str must be a string");for(var n={},o=t||{},s=e.split(";"),a=o.decode||r,c=0;c<s.length;c++){var u=s[c],d=u.indexOf("=");if(!(d<0)){var l=u.substring(0,d).trim();if(null==n[l]){var g=u.substring(d+1,u.length).trim();'"'===g[0]&&(g=g.slice(1,-1)),n[l]=i(g,a)}}}return n},t.serialize=function(e,t,r){var i=r||{},s=i.encode||n;if("function"!=typeof s)throw new TypeError("option encode is invalid");if(!o.test(e))throw new TypeError("argument name is invalid");var a=s(t);if(a&&!o.test(a))throw new TypeError("argument val is invalid");var c=e+"="+a;if(null!=i.maxAge){var u=i.maxAge-0;if(isNaN(u)||!isFinite(u))throw new TypeError("option maxAge is invalid");c+="; Max-Age="+Math.floor(u)}if(i.domain){if(!o.test(i.domain))throw new TypeError("option domain is invalid");c+="; Domain="+i.domain}if(i.path){if(!o.test(i.path))throw new TypeError("option path is invalid");c+="; Path="+i.path}if(i.expires){if("function"!=typeof i.expires.toUTCString)throw new TypeError("option expires is invalid");c+="; Expires="+i.expires.toUTCString()}i.httpOnly&&(c+="; HttpOnly");i.secure&&(c+="; Secure");if(i.sameSite){switch("string"==typeof i.sameSite?i.sameSite.toLowerCase():i.sameSite){case!0:c+="; SameSite=Strict";break;case"lax":c+="; SameSite=Lax";break;case"strict":c+="; SameSite=Strict";break;case"none":c+="; SameSite=None";break;default:throw new TypeError("option sameSite is invalid")}}return c};var r=decodeURIComponent,n=encodeURIComponent,o=/^[\u0009\u0020-\u007e\u0080-\u00ff]+$/;function i(e,t){try{return t(e)}catch(t){return e}}},763:(e,t,r)=>{r.r(t),r.d(t,{default:()=>n});const n='<!DOCTYPE html> <html lang="en"> <head> <meta charset="utf-8"/> <meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"/> <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous"/> <title>Authorization@Edge</title> <style>html{padding:0}body{display:flex;min-height:100%;margin:0;justify-content:center;align-items:flex-start}.message-card{flex-grow:1;max-width:600px;margin-top:2%}</style> </head> <body> <div class="card message-card"> <h5 class="card-header">Authorization@Edge</h5> <div class="card-body"> <h5 class="card-title">${title}</h5> <p> ${message} <a class="card-link" data-toggle="collapse" href="#details" role="button" aria-expanded="false" aria-controls="details"> ${expandText} </a> </p> <p class="collapse blockquote-footer" id="details"> ${details} [log region: ${region}] </p> <a href="${linkUri}" class="btn btn-primary" role="button">${linkText}</a> </div> </div> <script src="https://code.jquery.com/jquery-3.5.0.slim.min.js" integrity="sha384-/IFzzQmt1S744I+IQO4Mc1uphkxbXt1tEwjQ/qSw2p8pXWck09sLvqHmKDYYwReJ" crossorigin="anonymous"><\/script> <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"><\/script> </body> </html> '},9925:function(e,t,r){var n=this&&this.__createBinding||(Object.create?function(e,t,r,n){void 0===n&&(n=r);var o=Object.getOwnPropertyDescriptor(t,r);o&&!("get"in o?!t.__esModule:o.writable||o.configurable)||(o={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,n,o)}:function(e,t,r,n){void 0===n&&(n=r),e[n]=t[r]}),o=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&n(t,e,r);return o(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.handler=void 0;const s=r(3477),a=i(r(3249)),c=a.getCompleteConfig();c.logger.debug("Configuration loaded:",c);t.handler=async e=>{c.logger.debug("Event:",e);const t=e.Records[0].cf.request,r=t.headers.host[0].value,n=c.accessTokenEndpoint;let o,i=`https://${r}`;try{const e=a.extractAndParseCookies(t.headers,c.clientId,c.idTokenCookieName);({idToken:o}=e);const{code:u,pkce:d,requestedUri:l}=function(e){const{code:t,state:r,error:n,error_description:o}=(0,s.parse)(e.querystring);if(n)throw new Error(`[Cognito] ${n}: ${o}`);if(!t||!r||"string"!=typeof t||"string"!=typeof r)throw new Error(['Invalid query string. Your query string does not include parameters "state" and "code".',"This can happen if your authentication attempt did not originate from this site."].join(" "));let i;try{i=JSON.parse(Buffer.from(a.urlSafe.parse(r),"base64").toString())}catch{throw new Error('Invalid query string. Your query string does not include a valid "state" parameter')}if(!i.requestedUri||!i.nonce)throw new Error('Invalid query string. Your query string does not include a valid "state" parameter');const{nonce:u,pkce:d,nonceHmac:l}=e.cookies;if(!i.nonce||!u||i.nonce!==u){if(!u)throw new a.RequiresConfirmationError("Your browser didn't send the nonce cookie along, but it is required for security (prevent CSRF).");throw new a.RequiresConfirmationError("Nonce mismatch. This can happen if you start multiple authentication attempts in parallel (e.g. in separate tabs)")}if(!d)throw new Error("Your browser didn't send the pkce cookie along, but it is required for security (prevent CSRF).");const g=parseInt(i.nonce.slice(0,i.nonce.indexOf("T")));if(a.timestampInSeconds()-g>c.nonceMaxAge)throw new a.RequiresConfirmationError(`Nonce is too old (nonce is from ${new Date(1e3*g).toISOString()})`);const p=a.sign(i.nonce,c.nonceSigningSecret,c.nonceLength);if(p!==l)throw new a.RequiresConfirmationError(`Nonce signature mismatch! Expected ${p} but got ${l}`);return{code:t,pkce:d,requestedUri:i.requestedUri??""}}({querystring:t.querystring,cookies:e});c.logger.debug("Query string and cookies are valid"),i+=a.ensureValidRedirectPath(l);const g=(0,s.stringify)({grant_type:"authorization_code",client_id:c.clientId,redirect_uri:`https://${r}${c.redirectPathSignIn}`,code:u,code_verifier:d}),p={headers:{"Content-Type":"application/x-www-form-urlencoded"}};if(c.clientSecret){const e=Buffer.from(`${c.clientId}:${c.clientSecret}`).toString("base64");p.headers.Authorization=`Basic ${e}`}c.logger.debug("HTTP POST to IDP token endpoint:\n",{uri:n,body:g,requestConfig:p});const{status:f,headers:h,data:{id_token:m,access_token:y,refresh_token:k}}=await a.httpPostToIDPWithRetry(n,Buffer.from(g),p,c.logger,"POST").catch((e=>{throw new Error(`Failed to exchange authorization code for tokens: ${e}`)}));c.logger.info("Successfully exchanged authorization code for tokens"),c.logger.debug("Response from IDP token endpoint:\n",{status:f,headers:h,idToken:m,accessToken:y,refreshToken:k});const w={status:"307",statusDescription:"Temporary Redirect",headers:{location:[{key:"location",value:i}],"set-cookie":a.generateCookieHeaders.signIn({tokens:{id:m,access:y,refresh:k},...c}),...c.cloudFrontHeaders}};return c.logger.debug("Returning response:\n",w),w}catch(e){if(c.logger.error(e),o){c.logger.debug("ID token found, redirecting back to:",i);const e={status:"307",statusDescription:"Temporary Redirect",headers:{location:[{key:"location",value:i}],...c.cloudFrontHeaders}};return c.logger.debug("Returning response:\n",e),e}let t;t=e instanceof a.RequiresConfirmationError?{title:"Confirm sign-in",message:"We need your confirmation to sign you in –– to ensure",expandText:"your safety",details:e.toString(),linkUri:i,linkText:"Confirm"}:{title:"Sign-in issue",message:"We can't sign you in because of a",expandText:"technical problem",details:`${e}`,linkUri:i,linkText:"Try again"};const r={body:a.createErrorHtml(t),status:"200",headers:{...c.cloudFrontHeaders,"content-type":[{key:"Content-Type",value:"text/html; charset=UTF-8"}]}};return c.logger.debug("Returning response:\n",r),r}}},4443:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.fetch=void 0;const n=r(5687),o=r(2781);t.fetch=async function(e,t,r){return new Promise(((s,a)=>{const c={signal:AbortSignal.timeout(4e3),...r??{}},u=(0,n.request)(e,c,(e=>(0,o.pipeline)([e,i((t=>s({status:e.statusCode,headers:e.headers,data:t})))],d)));function d(e){e&&(u.destroy(e),a(e))}u.on("error",d),u.end(t)}))};const i=e=>{const t=[];return new o.Writable({write:(e,r,n)=>{try{t.push(e),n()}catch(e){n(e)}},final:r=>{try{e(Buffer.concat(t)),r()}catch(e){r(e)}}})}},3249:function(e,t,r){var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.fetchUrl=t.ensureValidRedirectPath=t.generateSecret=t.RequiresConfirmationError=t.timestampInSeconds=t.sign=t.urlSafe=t.createErrorHtml=t.httpPostToIDPWithRetry=t.generateCookieHeaders=t.extractAndParseCookies=t.getCookieNames=t.asCloudFrontHeaders=t.getCompleteConfig=t.getConfigWithHeaders=t.getConfig=void 0;const o=r(6113),i=r(7147),s=r(5687),a=r(5687),c=r(2781),u=r(3837),d=r(6489),l=n(r(763)),g=r(4443);var p;!function(e){e[e.none=0]="none",e[e.error=10]="error",e[e.warn=20]="warn",e[e.info=30]="info",e[e.debug=40]="debug"}(p||(p={}));class f{constructor(e){this.logLevel=e}format(e,t=10){return e.map((e=>(0,u.formatWithOptions)({depth:t},e))).join(" ")}info(...e){this.logLevel>=p.info&&console.log(this.format(e))}warn(...e){this.logLevel>=p.warn&&console.warn(this.format(e))}error(...e){this.logLevel>=p.error&&console.error(this.format(e))}debug(...e){this.logLevel>=p.debug&&console.trace(this.format(e))}}function h(){const e=JSON.parse((0,i.readFileSync)(`${__dirname}/configuration.json`).toString("utf8"));return{logger:new f(p[e.logLevel]),...e}}function m(){const e=h();if(!function(e){return void 0!==e.httpHeaders}(e))throw new Error("Incomplete config in configuration.json");return{cloudFrontHeaders:y(e.httpHeaders),...e}}function y(e){return e?Object.entries(e).reduce(((e,[t,r])=>Object.assign(e,{[t.toLowerCase()]:[{key:t,value:r}]})),{}):{}}function k(e,t){const r=`idp.${e}`;return{lastUserKey:`${r}.LastAuthUser`,scopeKey:`${r}.tokenScopesString`,idTokenKey:`${r}.idToken`,idToken2Key:t,accessTokenKey:`${r}.accessToken`,refreshTokenKey:`${r}.refreshToken`}}function w(e){const t={};let r;return r=k(e.clientId,e.idTokenCookieName),Object.assign(t,{[r.scopeKey]:`${e.oauthScopes.join(" ")}; ${e.cookieSettings.accessToken}`}),t[r.accessTokenKey]=`${e.tokens.access}; ${e.cookieSettings.accessToken}`,e.tokens.id&&(t[r.idTokenKey]=`${e.tokens.id}; ${e.cookieSettings.idToken}`,t[r.idToken2Key]=`${e.tokens.id}; ${e.cookieSettings.idToken}`),e.tokens.refresh&&(t[r.refreshTokenKey]=`${e.tokens.refresh}; ${e.cookieSettings.refreshToken}`),"signOut"===e.event&&Object.keys(t).forEach((e=>t[e]=b(t[e]))),["spa-auth-edge-nonce","spa-auth-edge-nonce-hmac","spa-auth-edge-pkce"].forEach((r=>{t[r]=b(`;${e.cookieSettings.nonce}`)})),Object.entries({...t}).map((([e,t])=>({key:"set-cookie",value:`${e}=${t}`})))}function b(e=""){const t=e.split(";").map((e=>e.trim())).filter((e=>!e.toLowerCase().startsWith("max-age"))).filter((e=>!e.toLowerCase().startsWith("expires"))),r=`Expires=${new Date(0).toUTCString()}`,[,...n]=t;return["",...n,r].join("; ")}t.getConfig=h,t.getConfigWithHeaders=m,t.getCompleteConfig=function(){const e=m(),t=(e.redirectPathAuthRefresh,{idToken:"Path=/; Secure; SameSite=Lax",accessToken:"Path=/; Secure; HttpOnly; SameSite=Lax",refreshToken:"Path=/; Secure; HttpOnly; SameSite=Lax",nonce:"Path=/; Secure; HttpOnly; SameSite=Lax"}),r=e.cookieSettings?Object.fromEntries(Object.entries({...t,...e.cookieSettings}).map((([e,r])=>[e,r||t[e]]))):t;return{...{secretAllowedCharacters:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~",pkceLength:43,nonceLength:16,nonceMaxAge:r?.nonce&&parseInt((0,d.parse)(r.nonce.toLowerCase())["max-age"])||86400},...e,cookieSettings:r}},t.asCloudFrontHeaders=y,t.getCookieNames=k,t.extractAndParseCookies=function(e,t,r){const n=function(e){return e.cookie?e.cookie.reduce(((e,t)=>Object.assign(e,(0,d.parse)(t.value))),{}):{}}(e);if(!n)return{};let o;return o=k(t,r),{tokenUserName:n[o.lastUserKey],idToken:n[o.idTokenKey],idToken2:n[o.idToken2Key],accessToken:n[o.accessTokenKey],refreshToken:n[o.refreshTokenKey],scopes:n[o.scopeKey],nonce:n["spa-auth-edge-nonce"],nonceHmac:n["spa-auth-edge-nonce-hmac"],pkce:n["spa-auth-edge-pkce"]}},t.generateCookieHeaders={signIn:e=>w({...e,event:"signIn"}),refresh:e=>w({...e,event:"refresh"}),signOut:e=>w({...e,event:"signOut"})};const S=new s.Agent({keepAlive:!0});t.httpPostToIDPWithRetry=async function(e,t,r,n,o){let i=0;for(;;){++i;try{return await(0,g.fetch)(e,t,{agent:S,...r,method:o}).then((e=>{if(200!==e.status)throw new Error(`Status is ${e.status}, expected 200`);if(!e.headers["content-type"]?.startsWith("application/json"))throw new Error(`Content-Type is ${e.headers["content-type"]}, expected application/json`);return{...e,data:JSON.parse(e.data.toString())}}))}catch(t){if(n.debug(`HTTP ${o} to ${e} failed (attempt ${i}):`),n.debug(t),i>=5)throw n.error(`No success after ${i} attempts, seizing further attempts`),t;i>=2&&(n.debug(`Doing exponential backoff with jitter, before attempting HTTP ${o} again ...`),await new Promise((e=>setTimeout(e,25*(Math.pow(2,i)+Math.random()*i)))),n.debug(`Done waiting, will try HTTP ${o} again now`))}}},t.createErrorHtml=function(e){const t={...e,region:process.env.AWS_REGION};return l.default.replace(/\${([^}]*)}/g,((e,r)=>function(e){if("string"!=typeof e)return;return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}(t[r])??""))},t.urlSafe={stringify:e=>e.replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_"),parse:e=>e.replace(/-/g,"+").replace(/_/g,"/")},t.sign=function(e,r,n){const i=(0,o.createHmac)("sha256",r).update(e).digest("base64").slice(0,n);return t.urlSafe.stringify(i)},t.timestampInSeconds=function(){return Date.now()/1e3|0};class v extends Error{}t.RequiresConfirmationError=v,t.generateSecret=function(e,t){return[...new Array(t)].map((()=>e[(0,o.randomInt)(0,e.length)])).join("")},t.ensureValidRedirectPath=function(e){return"string"!=typeof e?"/":e.startsWith("/")?e:`/${e}`},t.fetchUrl=async function(e){return new Promise(((t,r)=>{const n=(0,a.request)(e,(e=>(0,c.pipeline)([e,T(t)],o)));function o(e){e&&(n.destroy(e),r(e))}n.on("error",o),n.end()}))};const T=e=>{const t=[];return new c.Writable({write:(e,r,n)=>{try{t.push(e),n()}catch(e){n(e)}},final:r=>{try{e(Buffer.concat(t)),r()}catch(e){r(e)}}})}},6113:e=>{e.exports=require("crypto")},7147:e=>{e.exports=require("fs")},5687:e=>{e.exports=require("https")},3477:e=>{e.exports=require("querystring")},2781:e=>{e.exports=require("stream")},3837:e=>{e.exports=require("util")}},t={};function r(n){var o=t[n];if(void 0!==o)return o.exports;var i=t[n]={exports:{}};return e[n].call(i.exports,i,i.exports,r),i.exports}r.d=(e,t)=>{for(var n in t)r.o(t,n)&&!r.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var n=r(9925),o=exports;for(var i in n)o[i]=n[i];n.__esModule&&Object.defineProperty(o,"__esModule",{value:!0})})();